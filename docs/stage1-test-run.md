# Этап 1: Тестовый прогон (смена фаз в Telegram)

Цель: гарантированно видеть смену фаз `pre_event` → `during_event` → `post_event` в Telegram на тестовых событиях.

---

## Требования

Перед началом должен быть установлен **Node.js**. Если при запуске скрипта появилась ошибка `Command 'node' not found`, выполните:

```
sudo apt install nodejs
```

Введите пароль, когда система попросит. После установки снова запустите:

```
node scripts/update-test-event.js
```

---

## Пошаговая инструкция (подробно)

### Шаг 0. Откройте терминал

**Среда:** удалённый рабочий стол на Ubuntu.

- Нажмите **Ctrl+Alt+T** — откроется терминал.
- Или: Меню → «Программы» / «Activities» → найдите «Терминал».

Перейдите в папку проекта:

```
cd /home/artur/trade-system
```

(Если проект лежит в другом месте — подставьте свой путь.)

---

### Шаг 1. Обновить время тестового события

**Где:** терминал.  
**Зачем:** чтобы событие было через 20 минут от текущего момента.

Скопируйте и вставьте команду, нажмите Enter:

```
node scripts/update-test-event.js
```

**Ожидаемый вывод:**

```
[update-test-event] Written: .../data/simulated_day.json
[update-test-event] Event at: 2026-02-22T... (now + 20 min)
```

Если есть ошибка — убедитесь, что в папке проекта есть `scripts` и `data`, и что установлен Node.js.

---

### Шаг 2. Проверить .env

**Где:** любая программа для редактирования текста (Блокнот, VS Code, Notepad++).

1. Откройте файл `.env` в корне проекта (рядом с `README.md`).
2. Найдите строку `CALENDAR_TEST_MODE`.
3. Должно быть:

```
CALENDAR_TEST_MODE=true
```

Если стоит `false` — поменяйте на `true`, сохраните файл.

---

### Шаг 3. Запустить или перезапустить Docker

**Где:** терминал (в той же папке `trade-system`).

Если контейнеры ещё не запускали:

```
docker compose up -d
```

Если уже запускали — перезапуск:

```
docker compose restart
```

**Ожидаемый вывод:** идут строки про загрузку/перезапуск контейнеров `bridge`, `n8n`, `openclaw`. Завершение без красных ошибок — нормально.

---

### Шаг 4. Включить workflow в n8n

**Где:** браузер.

1. Откройте вкладку: http://localhost:5678  
2. Если попросит логин — войдите (если аккаунт уже создан).
3. Слева откройте **Workflows** → выберите **Volatility Window**.
4. В правом верхнем углу найдите переключатель **Active** (Inactive/Active).
5. Включите его, чтобы workflow стал активным (зелёный/ON).

После этого каждую минуту workflow будет проверять время и фазы событий.

---

### Шаг 5. Ждать сообщения в Telegram

**Где:** Telegram-канал/чат, указанный в `OPENCLAW_TELEGRAM_CHAT_ID`.

**Схема времени (если шаг 1 выполнен сейчас):**

| Что происходит | Когда (примерно) | Сообщение в Telegram |
|----------------|------------------|------------------------|
| pre_event      | сейчас + 1–20 мин | первое сообщение      |
| during_event   | сейчас + ~21–25 мин | второе сообщение   |
| post_event     | сейчас + ~26–40 мин | третье сообщение    |
| переход в GREEN | сейчас + ~41 мин | четвёртое сообщение   |

Workflow срабатывает **раз в минуту**. Сообщения могут приходить не ровно в минуту начала фазы, а с небольшой задержкой (1–2 минуты).

---

### Шаг 6. Проверить логи bridge (по желанию)

**Где:** новый терминал (можно оставить предыдущий открытым).

Чтобы видеть логи в реальном времени:

```
docker logs bridge -f
```

Появится поток текста. Ищите строки с `[bridge:event]` — там будет `transition_type` и `phase`. Остановка просмотра: Ctrl+C.

---

### Шаг 7. После теста — вернуть настройки

Когда проверка завершена:

1. **n8n:** переключить **Active** в OFF.
2. **Файл .env:** поставить `CALENDAR_TEST_MODE=false`.
3. **Терминал:**

```
cp data/simulated_day.backup.json data/simulated_day.json
docker compose restart
```

---

## Подготовка (кратко)

### 1. Обновить тестовое расписание (опционально)

**Вариант A — динамическое время (рекомендуется):**

```bash
node scripts/update-test-event.js
```

Установит одно событие на `now + 20 min` в `data/simulated_day.json`.

**Вариант B — фиксированное время:**

Используйте `data/simulated_day.json` как есть (2 события в 12:20 и 12:45 UTC). Запускать тест около **12:00 UTC** (или измените `time` у событий под своё локальное время).

### 2. Включить тестовый режим в .env

В корне проекта в `.env`:

```
CALENDAR_TEST_MODE=true
```

(И `OPENCLAW_TELEGRAM_CHAT_ID`, `OPENCLAW_GATEWAY_TOKEN` и т.д., если ещё не настроены.)

### 3. Перезапустить стек

```bash
docker compose restart
```

(Или `docker compose up -d`, если контейнеры не запущены.)

### 4. Включить workflow в n8n

1. Откройте n8n: http://localhost:5678  
2. Откройте workflow **«Volatility Window»**  
3. Включите его: переключатель **Active** → ON  
4. Workflow будет выполняться каждую минуту по крону  

## Что смотреть

### За один цикл теста ожидаются минимум:

- `pre_event` — 20 мин до события  
- `during_event` — 5 мин во время события  
- `post_event` — 15 мин после события  

При двух событиях (12:20 и 12:45 UTC) смотрите несколько переходов.

### Где видно, какой переход вызвал отправку

1. **n8n → Executions:**  
   - Откройте workflow → вкладка **Executions**  
   - У успешного запуска посмотрите выход **Compute Volatility State**: `state`, `phase`, `context.event_name`  
   - Сравнение с предыдущим запуском показывает, что именно изменилось  

2. **Логи bridge (контейнер):**

   ```bash
   docker logs bridge -f
   ```

   Ищите `[bridge:event]`, в поле `transition_type`:
   - `state_change` — смена RED/GREEN  
   - `phase_change` — смена фазы внутри RED (pre_event → during_event → post_event)  

3. **Telegram:**  
   Сообщения должны приходить при каждом таком переходе.

## Критерий успеха (жёсткий)

За один тестовый цикл должны наблюдаться:

### В Telegram
- 1 сообщение `pre_event`
- 1 сообщение `during_event`
- 1 сообщение `post_event`
- 1 переход в GREEN

### В логах bridge (`transition_type` в `[bridge:event]`)
```
state_change:  GREEN → RED (pre_event)
phase_change:  pre_event → during_event
phase_change:  during_event → post_event
state_change:  post_event → GREEN
```

### Метрики
- `llm_called` = `true` только при смене фазы
- одно сообщение на каждую фазу
- без дубликатов

### Где смотреть
- Telegram-канал
- Логи `bridge:event`
- Executions в n8n

## Провал если
- ❌ Нет сообщения хотя бы для одной фазы
- ❌ Два сообщения `during_event` подряд
- ❌ Нет перехода обратно в GREEN
- ❌ `llm_called=true` без смены фазы

## Возврат к предсказуемому состоянию после теста

1. Остановите workflow в n8n (переключатель Active → OFF).  
2. В `.env` верните:

   ```
   CALENDAR_TEST_MODE=false
   ```

3. Восстановите `data/simulated_day.json`:

   ```bash
   cp data/simulated_day.backup.json data/simulated_day.json
   ```

4. Перезапустите контейнеры:

   ```bash
   docker compose restart
   ```
